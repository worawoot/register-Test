<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 1. โหลด TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. โหลด Google Font (IBM Plex Sans Thai) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- 3. โหลด SweetAlert2 -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* 4. ตั้งค่า Font หลักให้เป็น IBM Plex Sans Thai */
    body {
      font-family: 'IBM Plex Sans Thai', sans-serif;
    }

    /* Custom style สำหรับ Checkbox ที่ดูดีขึ้น */
    .form-checkbox:checked {
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-lg bg-white rounded-lg shadow-xl p-6 md:p-10">

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-blue-700">
        ระบบลงทะเบียน MWA e-Bill
      </h1>
    </div>

    <!-- Form -->
    <form id="registrationForm">

      <!-- 1. ทะเบียนผู้ใช้น้ำ -->
      <div class="mb-4">
        <label for="waterAccount" class="block text-sm font-semibold text-gray-700 mb-2">
          ทะเบียนผู้ใช้น้ำ <span style="color: #f90202">*</span>
        </label>
        <input type="text" id="waterAccount" name="waterAccount"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="กรอกทะเบียนผู้ใช้น้ำ" pattern="[0-9]{8}"
               title="กรอกทะเบียนผู้ใช้น้ำ 8 หลัก "required>
      </div>

      <!-- 2. ชื่อ-นามสกุล -->
      <div class="mb-4">
        <label for="fullName" class="block text-sm font-semibold text-gray-700 mb-2">
          ชื่อ-นามสกุล <span style="color: #f90202">*</span>
        </label>
        <input type="text" id="fullName" name="fullName"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="กรอกชื่อและนามสกุล" required>
      </div>

      <!-- 3. เบอร์โทรศัพท์ -->
      <div class="mb-4">
        <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
          เบอร์โทรศัพท์ (10 หลัก) <span style="color: #f90202">*</span>
        </label>
        <input type="tel" id="phone" name="phone"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="เช่น 0812345678" pattern="0[0-9]{9}"
               title="กรอกเบอร์โทรศัพท์ 10 หลัก (ขึ้นต้นด้วย 0)" required>
      </div>

      <!-- 4. E-mail -->
      <div class="mb-4">
        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
          E-mail
        </label>
        <input type="email" id="email" name="email"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="example@mail.com" >
      </div>

      <!-- 5. & 6. Checkboxes -->
      <div class="mb-6 space-y-3">
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          เลือกประเภทเอกสารที่ต้องการรับ (e-Service) <span style="color: #f90202">*</span>
        </label>

        <div class="flex items-center">
          <input type="checkbox" id="waterBillCheck" name="waterBillCheck"
                 class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked>
          <label for="waterBillCheck" class="ml-3 text-gray-700">
            ใบแจ้งค่าน้ำประปา (e-Bill)
          </label>
        </div>

        <div class="flex items-center">
          <input type="checkbox" id="taxInvoiceCheck" name="taxInvoiceCheck"
                 class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked>
          <label for="taxInvoiceCheck" class="ml-3 text-gray-700">
            ใบกำกับภาษี (e-Tax Invoice)
          </label>
        </div>
      </div>

      <!-- Submit Button -->
      <div>
        <button type="submit" id="submitButton"
                class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg
                       hover:bg-blue-700 focus:outline-none focus:ring-2 
                       focus:ring-blue-500 focus:ring-opacity-50
                       transition-colors duration-200">
          ลงทะเบียน
        </button>
      </div>

    </form>
  </div>



  <script>
    // 6. JavaScript สำหรับ Form Submit และ SweetAlert
    const form = document.getElementById('registrationForm');
    
    form.addEventListener('submit', function(event) {
      event.preventDefault(); // ป้องกันการ Submit แบบปกติ

      // --- START: NEW CHECKBOX VALIDATION ---
      // ดึงค่าการ check
      const waterBillChecked = document.getElementById('waterBillCheck').checked;
      const taxInvoiceChecked = document.getElementById('taxInvoiceCheck').checked;

      // ตรวจสอบว่าไม่ได้เลือกทั้งคู่
      if (!waterBillChecked && !taxInvoiceChecked) {
        Swal.fire({
          icon: 'warning',
          title: 'กรุณาเลือกเอกสาร',
          text: 'คุณต้องเลือกรับเอกสารอย่างน้อย 1 ประเภท (e-Bill หรือ e-Tax Invoice)',
        });
        return; // หยุดการทำงาน ไม่ส่งฟอร์ม
      }
      // --- END: NEW CHECKBOX VALIDATION ---
      
      // แสดง SweetAlert "กำลังโหลด"
      Swal.fire({
        title: 'กำลังบันทึกข้อมูล...',
        text: 'กรุณารอสักครู่',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // รวบรวมข้อมูลจากฟอร์ม
      const formData = {
        waterAccount: document.getElementById('waterAccount').value,
        fullName: document.getElementById('fullName').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        waterBill: document.getElementById('waterBillCheck').checked,
        taxInvoice: document.getElementById('taxInvoiceCheck').checked
      };

      // ส่งข้อมูลไปที่ Code.gs โดยใช้ google.script.run
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .saveData(formData);
    });

    /**
     * ฟังก์ชันที่ถูกเรียกเมื่อการบันทึกสำเร็จ (จาก Code.gs)
     */
    function onSuccess(result) {
      if (result.success) {
        // แสดง SweetAlert "สำเร็จ"
        Swal.fire({
          icon: 'success',
          title: 'บันทึกข้อมูลสำเร็จ!',
          text: result.message,
        });
        form.reset(); // ล้างค่าในฟอร์ม
      } else {
        // แสดง SweetAlert "ผิดพลาด" (กรณี Server ส่ง error กลับมา)
        onFailure(result);
      }
    }

    /**
     * ฟังก์ชันที่ถูกเรียกเมื่อการบันทึกล้มเหลว
     */
    function onFailure(error) {
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด',
        // ถ้า error.message มีค่า (จาก Server) ให้ใช้ค่านั้น, ถ้าไม่มี (จาก Client) ให้ใช้ค่า default
        text: error.message || 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
      });
    }
  </script>

</body>

</html>
